#!/bin/sh

main() {
    # Some housekeeping...
    rm -rf dst tmp && mkdir -p src dst/posts dst/tags tmp/tags

    # Generate tmp/index.md & tmp/archive.md & tmp/tags.md & tmp/tags/example-tag.md files.
    # using our posts as a source
    find src/posts -type f -name "*.md" | sort -r | generate_tmp_md_files

    # Find all markdown files and turn them into corresponding html in the dst path.
    find src tmp -type f -name "*.md" -print0 | \
        xargs -0 -I {} sh -c 'md_file_to_html_file "{}" > "$(src_to_dst_path "{}")"'
    // TODO: maybe creat a function to avoid this horrible stuff.

    # Generate tags.html file. Grab the list of tags from our tmp/tags directory, then chuck them
    # all into a tmp directory, which we then sort & pandoc-ise.
    find tmp/tags -type f -print0 | xargs -0 -I {} basename {} ".md" |  xargs -I {} -n1 sh -c \
        'echo "- [{}](tags/{}.html) ($(wc -l < tmp/tags/{}.md | xargs))"' >> tmp/tags-unsorted.md
    sort tmp/tags-unsorted.md > tmp/tags.md
    md_file_to_html_file tmp/tags.md > dst/tags.html

    cp -r src/css dst/css

    echo "Generated $(find dst | wc -l) files"
}

md_file_to_html_file() {
    input_file="$1"
    pandoc \
        --css="/css/style.css" \
        --include-before-body src/_top.html \
        --include-after-body src/_bottom.html \
        --title "Will Clarke" \
        --to=html5  \
        "$input_file"
}

src_to_dst_path() {
    echo "$1" | sed -e's/src/dst/' -e 's/tmp/dst/' -e's/\.md$/\.html/'
}

generate_tmp_md_files() {
    printf "Hello!ðŸ‘‹ðŸ˜ƒ\n\nI'm a software engineer based in the UK.\n\n---\n\n" > tmp/index.md
    while read -r file_path
    do
        md_file=$(cat "$file_path")
        title=$(echo "$md_file" | grep -iE '^title: ' | cut -d' ' -f 2-)
        description=$(echo "$md_file" | grep -iE '^description: ' | cut -d' ' -f 2-)
        date=$(echo "$md_file" | grep -iE '^date: ' | cut -d' ' -f 2-)
        tags=$(echo "$md_file" | grep -iE '^tags: ' | cut -d' ' -f 2-)

        dst_path=$(src_to_dst_path "$file_path" | sed 's#dst/##')
        linked_tags=$(echo "$tags" | xargs -n1 -I {} echo "[{}](/tags/{}.html)")

        printf "# [%s](%s)\n%s\n%s\n\n" "$title" "$dst_path" "$description" "$linked_tags" >> tmp/index.md
        printf -- "- *%s* [%s](%s)\n\n" "$date" "$title" "$dst_path" >> tmp/archive.md
        echo "$tags" | xargs -n1 -I "{tag}" sh -c "echo \"- *[$title]($dst_path)* $date\" >> tmp/tags/{tag}.md"
    done
}

export -f md_file_to_html_file
export -f src_to_dst_path

main

# TODOs
# - tag headers on tag pages
# - rss feed
